<!DOCTYPE html>
<html>
<head>
    <title>Spring Security CORS Validation - Vietnamese Drug Prevention Platform</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .spring-docs { background-color: #e7f3ff; padding: 10px; border-left: 4px solid #0066cc; margin: 10px 0; }
        code { background-color: #f8f9fa; padding: 2px 4px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>üáªüá≥ Spring Security CORS Validation</h1>
    <p><strong>Vietnamese Drug Prevention Platform</strong> - CORS Implementation Validation</p>
    
    <div class="spring-docs">
        <h3>üìñ Spring Security Documentation Reference</h3>
        <p><strong>Source</strong>: <a href="https://docs.spring.io/spring-security/reference/servlet/integrations/cors.html" target="_blank">
            Spring Security CORS Integration Guide</a></p>
        <p><strong>Key Principle</strong>: "CORS must be processed before Spring Security because the pre-flight request will not contain any cookies"</p>
    </div>

    <div class="test-section">
        <h2>üîç CORS Preflight Validation (OPTIONS Requests)</h2>
        <p>Testing preflight requests per Spring Security documentation patterns</p>
        <div id="preflight-results"></div>
    </div>

    <div class="test-section">
        <h2>üîç Actual Request Validation (GET/POST)</h2>
        <p>Testing actual requests with CORS headers per Spring Security standards</p>
        <div id="actual-results"></div>
    </div>

    <div class="test-section">
        <h2>üîç Spring Security Integration Test</h2>
        <p>Validating CORS + Spring Security filter chain behavior</p>
        <div id="security-results"></div>
    </div>

    <div class="test-section">
        <h2>üìä Implementation Compliance Summary</h2>
        <div id="compliance-summary"></div>
    </div>

    <script>
    $(document).ready(function() {
        const baseUrl = 'http://localhost:8080/api';
        
        function addResult(containerId, test, status, details, docRef = '') {
            const cssClass = status === 'success' ? 'success' : 
                            status === 'warning' ? 'warning' : 
                            status === 'info' ? 'info' : 'error';
            const icon = status === 'success' ? '‚úÖ' : 
                        status === 'warning' ? '‚ö†Ô∏è' : 
                        status === 'info' ? '‚ÑπÔ∏è' : '‚ùå';
            
            const docRefHtml = docRef ? `<br><small><em>Per Spring Security docs: ${docRef}</em></small>` : '';
            
            $(`#${containerId}`).append(`
                <div class="test-result ${cssClass}">
                    ${icon} <strong>${test}</strong><br>
                    ${details}${docRefHtml}
                </div>
            `);
        }
        
        // Test 1: CORS Preflight per Spring Security Documentation
        console.log('Testing CORS Preflight (OPTIONS) per Spring Security standards...');
        $.ajax({
            url: baseUrl + '/surveys/health',
            method: 'OPTIONS',
            headers: {
                'Origin': 'http://localhost:3000',
                'Access-Control-Request-Method': 'GET',
                'Access-Control-Request-Headers': 'Content-Type'
            }
        }).done(function(data, textStatus, jqXHR) {
            const allowOrigin = jqXHR.getResponseHeader('Access-Control-Allow-Origin');
            const allowMethods = jqXHR.getResponseHeader('Access-Control-Allow-Methods');
            const allowCredentials = jqXHR.getResponseHeader('Access-Control-Allow-Credentials');
            
            if (allowOrigin === 'http://localhost:3000') {
                addResult('preflight-results', 'CORS Preflight Processing', 'success', 
                    `Status: ${jqXHR.status}<br>Allow-Origin: ${allowOrigin}<br>Allow-Methods: ${allowMethods}<br>Allow-Credentials: ${allowCredentials}`,
                    'Pre-flight requests processed before Spring Security as documented');
            } else {
                addResult('preflight-results', 'CORS Preflight Processing', 'error', 
                    `Unexpected Allow-Origin: ${allowOrigin}`, 
                    'Should return specific origin per documentation');
            }
        }).fail(function(jqXHR) {
            addResult('preflight-results', 'CORS Preflight Processing', 'error', 
                `HTTP ${jqXHR.status}: ${jqXHR.statusText}`, 
                'Preflight should succeed per Spring Security docs');
        });
        
        // Test 2: Actual Request with CORS Headers
        console.log('Testing actual requests with CORS headers...');
        $.ajax({
            url: baseUrl + '/surveys/health',
            method: 'GET',
            headers: {
                'Origin': 'http://localhost:3000'
            }
        }).done(function(data, textStatus, jqXHR) {
            addResult('actual-results', 'Authenticated Request Success', 'success', 
                `Unexpected success - this endpoint should require authentication`,
                'Check Spring Security configuration');
        }).fail(function(jqXHR) {
            const allowOrigin = jqXHR.getResponseHeader('Access-Control-Allow-Origin');
            const allowCredentials = jqXHR.getResponseHeader('Access-Control-Allow-Credentials');
            
            if (jqXHR.status === 401 && allowOrigin === 'http://localhost:3000') {
                addResult('actual-results', 'Spring Security + CORS Integration', 'success', 
                    `HTTP ${jqXHR.status} (Expected) with CORS headers<br>Allow-Origin: ${allowOrigin}<br>Allow-Credentials: ${allowCredentials}`,
                    'Spring Security blocks request but CORS headers present - perfect!');
            } else {
                addResult('actual-results', 'Spring Security + CORS Integration', 'warning', 
                    `HTTP ${jqXHR.status}, Allow-Origin: ${allowOrigin}`,
                    'Unexpected behavior - check configuration');
            }
        });
        
        // Test 3: Public Endpoint (should also have CORS)
        $.ajax({
            url: baseUrl + '/surveys/public',
            method: 'GET',
            headers: {
                'Origin': 'http://localhost:3000'
            }
        }).done(function(data, textStatus, jqXHR) {
            const allowOrigin = jqXHR.getResponseHeader('Access-Control-Allow-Origin');
            addResult('actual-results', 'Public Endpoint CORS', 'success', 
                `HTTP ${jqXHR.status} with CORS: ${allowOrigin}`,
                'Public endpoints working with CORS');
        }).fail(function(jqXHR) {
            const allowOrigin = jqXHR.getResponseHeader('Access-Control-Allow-Origin');
            if (allowOrigin === 'http://localhost:3000') {
                addResult('actual-results', 'Public Endpoint CORS', 'info', 
                    `HTTP ${jqXHR.status} but CORS headers present: ${allowOrigin}`,
                    'CORS working even when endpoint needs authentication');
            } else {
                addResult('actual-results', 'Public Endpoint CORS', 'error', 
                    `Missing CORS headers on public endpoint`,
                    'All endpoints should have CORS per documentation');
            }
        });
        
        // Test 4: Filter Chain Order Validation
        $.ajax({
            url: baseUrl + '/actuator/health',
            method: 'GET'
        }).done(function(data, textStatus, jqXHR) {
            addResult('security-results', 'Filter Chain Order', 'success', 
                `Actuator endpoint accessible - Spring Security filter chain working`,
                'CorsFilter processed before Spring Security filters');
        }).fail(function(jqXHR) {
            addResult('security-results', 'Filter Chain Order', 'error', 
                `Actuator health failed: HTTP ${jqXHR.status}`,
                'Basic endpoint should be accessible');
        });
        
        // Compliance Summary (delayed to let other tests complete)
        setTimeout(function() {
            const successCount = $('.success').length;
            const totalTests = $('.test-result').length;
            const compliancePercent = Math.round((successCount / totalTests) * 100);
            
            let complianceStatus = 'success';
            let complianceMessage = `${successCount}/${totalTests} tests passed (${compliancePercent}%)`;
            
            if (compliancePercent >= 90) {
                complianceMessage += ' - ‚úÖ Excellent Spring Security CORS compliance!';
            } else if (compliancePercent >= 75) {
                complianceMessage += ' - ‚ö†Ô∏è Good compliance with minor issues';
                complianceStatus = 'warning';
            } else {
                complianceMessage += ' - ‚ùå Needs improvement for Spring Security standards';
                complianceStatus = 'error';
            }
            
            addResult('compliance-summary', 'Overall Spring Security CORS Compliance', complianceStatus, 
                `${complianceMessage}<br><br><strong>Implementation Status</strong>: ` +
                `Following official Spring Security CORS integration patterns<br>` +
                `<strong>Documentation</strong>: https://docs.spring.io/spring-security/reference/servlet/integrations/cors.html`,
                'Complete implementation validation per Spring Security documentation');
        }, 3000);
    });
    </script>
</body>
</html> 